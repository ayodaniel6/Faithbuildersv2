{% extends 'base.html' %}
{% load static %}
{% block content %}

<!-- CSRF & JS -->
<meta name="csrf-token" content="{{ csrf_token }}" />
<link rel="stylesheet" href="{% static 'blog/css/post_detail.css' %}">

<script src="{% static 'blog/js/comment.js' %}" defer></script>
<script src="{% static 'blog/js/like.js' %}" defer></script>
<script src="{% static 'blog/js/bookmark.js' %}" defer></script>
<script src="{% static 'blog/js/restAPI.js' %}" defer></script>

<!-- Post Hero -->
<div class="relative bg-gradient-to-r from-indigo-100/60 to-indigo-50/40 dark:from-gray-800 dark:to-gray-900 p-8 rounded-2xl shadow-lg mb-10 opacity-0 animate-fadeIn">
  <h1 class="text-4xl sm:text-5xl font-bold leading-tight mb-3 text-gray-900 dark:text-white">
    {{ post.title }}
  </h1>
  <p class="text-sm text-gray-600 dark:text-gray-400">
    By <span class="font-semibold">{{ post.author }}</span> · {{ post.date_published|date:"F j, Y" }}
  </p>
</div>

<!-- Media Preview -->
{% if post.video_url %}
  <div class="mb-10 rounded-2xl overflow-hidden shadow-md max-w-4xl mx-auto opacity-0 animate-fadeIn">
    {% if "youtube.com" in post.video_url or "youtu.be" in post.video_url %}
      {% if "watch?v=" in post.video_url %}
        {% with video_id=post.video_url|cut:"https://www.youtube.com/watch?v=" %}
          <iframe class="w-full max-h-[480px] mx-auto rounded-lg"
            src="https://www.youtube.com/embed/{{ video_id }}"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>
        {% endwith %}
      {% elif "youtu.be" in post.video_url %}
        {% with video_id=post.video_url|cut:"https://youtu.be/" %}
          <iframe class="w-full max-h-[480px] mx-auto rounded-lg"
            src="https://www.youtube.com/embed/{{ video_id }}"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>
        {% endwith %}
      {% endif %}
    {% else %}
      <video class="w-full max-h-[480px] mx-auto rounded-lg" controls preload="metadata">
        <source src="{{ post.video_url }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    {% endif %}
  </div>

{% elif post.image %}
  <div class="mb-10 rounded-2xl overflow-hidden shadow-md max-w-4xl mx-auto opacity-0 animate-fadeIn">
    <img src="{{ post.image.url }}" alt="{{ post.title }}"
         class="w-full object-cover max-h-[480px] mx-auto rounded-lg hover:scale-[1.02] transform transition duration-500"
         loading="lazy" />
  </div>
{% endif %}

<!-- Post Content -->
<div class="prose dark:prose-invert max-w-4xl mx-auto text-lg leading-relaxed mb-12 opacity-0 animate-fadeIn">
  {{ post.content|safe }}
</div>

<!-- Interactive Panel -->
<div class="flex justify-between items-center border-t border-gray-200 dark:border-gray-700 pt-6 pb-4 text-sm text-gray-600 dark:text-gray-400 max-w-4xl mx-auto opacity-0 animate-fadeIn">
  <div class="flex space-x-6">
    <button id="like-btn"
            data-post-id="{{ post.id }}"
            class="flex items-center gap-1 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-300">
      ❤️ Like (<span id="like-count">{{ post.likes.count }}</span>)
    </button>

    <button id="bookmark-btn"
            data-post-id="{{ post.id }}"
            class="flex items-center gap-1 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-300">
      {% if request.user in post.bookmarks.all %}
        🔖 Remove Bookmark
      {% else %}
        🔖 Bookmark
      {% endif %}
    </button>
  </div>

  <p>
    <strong>{{ post.like_count }}</strong> likes ·
    <strong>{{ post.comment_count }}</strong> comments
  </p>
</div>

<!-- Comments -->
<div class="max-w-4xl mx-auto mt-12 opacity-0 animate-fadeIn">
  <h3 class="text-xl font-semibold mb-6 text-gray-800 dark:text-white flex items-center gap-2">
    🗨️ Comments
  </h3>

  {% if user.is_authenticated %}
    <form id="comment-form" class="space-y-4 mb-8">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit"
              class="px-5 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors duration-300 shadow-sm">
        Add Comment
      </button>
    </form>
  {% else %}
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-8">
      <a href="{% url 'accounts:login' %}" class="text-indigo-600 dark:text-indigo-400 hover:underline">
        Login
      </a>
      to comment.
    </p>
  {% endif %}

  <div id="comment-list" class="space-y-6">
    {% for comment in comments %}
      <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm hover:shadow-md transition-shadow duration-300">
        <p class="text-base text-gray-800 dark:text-gray-200">{{ comment.content }}</p>
        <p class="text-xs text-gray-500 mt-2">
          — <strong>{{ comment.user }}</strong>, {{ comment.created_at|date:"F j, Y H:i" }}
        </p>
      </div>
    {% empty %}
      <p class="text-gray-500 dark:text-gray-400">No comments yet. Be the first!</p>
    {% endfor %}
  </div>
</div>

{% endblock %}
